@page "/login"
@using Microsoft.AspNetCore.Components
@inject AuctionSystem.Client.Services.AuthService Auth
@inject NavigationManager Nav

<h3>Login</h3>

<div class="mb-3">
    <label>Username</label>
    <input class="form-control" @bind="username" />
</div>

<div class="mb-3">
    <label>Password</label>
    <input class="form-control" type="password" @bind="password" />
</div>

<button class="btn btn-primary" @onclick="OnLogin" disabled="@isBusy">Login</button>

@if (!string.IsNullOrEmpty(message))
{
    <div class="mt-3 alert @(isError ? "alert-danger" : "alert-success")">@message</div>
}

@code {
    [Parameter, SupplyParameterFromQuery] public string? returnUrl { get; set; }

    string username = "";
    string password = "";
    string? message;
    bool isError = false;
    bool isBusy = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // თუ უკვე გაქვს შენახული token, ჩაიტვირთოს (auto-login case)
            await Auth.InitializeAsync();
            StateHasChanged();
        }
    }

    private async Task OnLogin()
    {
        message = null; isError = false; isBusy = true;
        try
        {
            var ok = await Auth.Login(username, password);
            if (ok)
            {
                // თუ returnUrl არ არის, გადადი Auctions-ზე
                var target = string.IsNullOrWhiteSpace(returnUrl) ? "/auctions" : returnUrl!;
                Nav.NavigateTo(target, forceLoad: true);
            }
            else
            {
                message = "Invalid username or password.";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = ex.Message;
            isError = true;
        }
        finally
        {
            isBusy = false;
        }
    }
}
